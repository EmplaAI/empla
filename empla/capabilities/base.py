"""
Base Capability Abstraction

Defines the core interface and models for all capabilities.
"""

from abc import ABC, abstractmethod
from typing import List, Dict, Any, Optional
from datetime import datetime, timezone
from uuid import UUID
from enum import Enum
from pydantic import BaseModel, Field
import logging

logger = logging.getLogger(__name__)


class CapabilityType(str, Enum):
    """
    Types of capabilities available to employees.

    Each capability type corresponds to a specific way employees
    can interact with the external world.
    """

    EMAIL = "email"
    CALENDAR = "calendar"
    MESSAGING = "messaging"
    BROWSER = "browser"
    DOCUMENT = "document"
    CRM = "crm"
    VOICE = "voice"
    COMPUTER_USE = "computer_use"


class CapabilityConfig(BaseModel):
    """
    Base configuration for all capabilities.

    Each capability extends this with capability-specific configuration.
    """

    enabled: bool = True
    """Whether this capability is enabled"""

    rate_limit: Optional[int] = None
    """Max operations per minute (None = unlimited)"""

    retry_policy: Dict[str, Any] = Field(
        default={"max_retries": 3, "backoff": "exponential"}
    )
    """Retry policy for failed operations"""

    timeout_seconds: int = 30
    """Operation timeout in seconds"""

    class Config:
        extra = "allow"  # Allow capability-specific config


class Observation(BaseModel):
    """
    Single observation from a capability.

    Observations are generated during perception and passed to the
    BDI system for reasoning.
    """

    source: str
    """Which capability generated this observation"""

    type: str
    """Type of observation (e.g., 'new_email', 'calendar_event')"""

    timestamp: datetime
    """When this observation was made"""

    priority: int = Field(ge=1, le=10, default=5)
    """Priority 1-10, higher = more important"""

    data: Dict[str, Any]
    """Observation-specific data"""

    requires_action: bool = False
    """Should this trigger immediate action?"""

    class Config:
        json_schema_extra = {
            "example": {
                "source": "email",
                "type": "new_email",
                "timestamp": "2025-11-12T10:30:00Z",
                "priority": 8,
                "data": {
                    "email_id": "123",
                    "from": "customer@example.com",
                    "subject": "Urgent: Need help",
                },
                "requires_action": True,
            }
        }


class Action(BaseModel):
    """
    Action to be executed by a capability.

    Actions are generated by the BDI system during intention execution
    and passed to capabilities for execution.
    """

    capability: str
    """Which capability should execute this action"""

    operation: str
    """What operation to perform (capability-specific)"""

    parameters: Dict[str, Any]
    """Operation parameters"""

    priority: int = Field(ge=1, le=10, default=5)
    """Action priority 1-10"""

    deadline: Optional[datetime] = None
    """When this action must be completed by"""

    context: Dict[str, Any] = Field(default_factory=dict)
    """Additional context for execution"""

    class Config:
        json_schema_extra = {
            "example": {
                "capability": "email",
                "operation": "send_email",
                "parameters": {
                    "to": ["recipient@example.com"],
                    "subject": "Response to your inquiry",
                    "body": "Thank you for reaching out...",
                },
                "priority": 7,
                "context": {"thread_id": "thread-123"},
            }
        }


class ActionResult(BaseModel):
    """
    Result of executing an action.

    Returned by capabilities after action execution.
    """

    success: bool
    """Whether the action succeeded"""

    output: Optional[Any] = None
    """Action output (capability-specific)"""

    error: Optional[str] = None
    """Error message if failed"""

    metadata: Dict[str, Any] = Field(default_factory=dict)
    """Additional metadata (timing, cost, etc.)"""

    class Config:
        json_schema_extra = {
            "example": {
                "success": True,
                "output": {"email_id": "456", "sent_at": "2025-11-12T10:35:00Z"},
                "error": None,
                "metadata": {"duration_ms": 234, "provider": "microsoft_graph"},
            }
        }


class BaseCapability(ABC):
    """
    Base class for all capabilities.

    A capability is a discrete unit of functionality that provides:
    1. **Perception** - observe environment for changes/events
    2. **Action** - execute specific operations
    3. **State** - maintain capability-specific state

    Capabilities are:
    - **Tenant-scoped** - isolated per customer
    - **Employee-scoped** - per-employee configuration
    - **Observable** - comprehensive logging and metrics
    - **Testable** - mock implementations available

    Example:
        class MyCapability(BaseCapability):

            @property
            def capability_type(self) -> CapabilityType:
                return CapabilityType.EMAIL

            async def initialize(self) -> None:
                # Set up connections, auth, etc.
                pass

            async def perceive(self) -> List[Observation]:
                # Check for new events
                return [...]

            async def execute_action(self, action: Action) -> ActionResult:
                # Execute operation
                return ActionResult(success=True)
    """

    def __init__(
        self, tenant_id: UUID, employee_id: UUID, config: CapabilityConfig
    ):
        """
        Initialize capability.

        Args:
            tenant_id: Tenant this capability belongs to
            employee_id: Employee this capability is for
            config: Capability configuration
        """
        self.tenant_id = tenant_id
        self.employee_id = employee_id
        self.config = config
        self._initialized = False

    @property
    @abstractmethod
    def capability_type(self) -> CapabilityType:
        """
        Type of this capability.

        Returns:
            CapabilityType enum value
        """
        pass

    @abstractmethod
    async def initialize(self) -> None:
        """
        Initialize capability - set up connections, auth, etc.

        Called once when capability is enabled for an employee.
        Should set self._initialized = True on success.

        Raises:
            Exception: If initialization fails
        """
        pass

    @abstractmethod
    async def perceive(self) -> List[Observation]:
        """
        Observe environment - check for new events, changes, triggers.

        Called periodically by proactive loop (frequency depends on config).

        Returns:
            List of observations (can be empty if nothing new)

        Note:
            Should not raise exceptions - log errors and return empty list
        """
        pass

    @abstractmethod
    async def execute_action(self, action: Action) -> ActionResult:
        """
        Execute a specific action.

        Called when employee decides to act (via BDI intention execution).

        Args:
            action: Action to execute with parameters

        Returns:
            Result of action execution

        Note:
            Should not raise exceptions - catch and return ActionResult with error
        """
        pass

    async def shutdown(self) -> None:
        """
        Clean shutdown - close connections, flush state.

        Called when capability is disabled or employee deactivated.
        Override if cleanup is needed.
        """
        pass

    def is_healthy(self) -> bool:
        """
        Health check - is capability functioning properly?

        Used for monitoring and alerting.

        Returns:
            True if healthy, False otherwise
        """
        return self._initialized

    def __repr__(self) -> str:
        return (
            f"{self.__class__.__name__}("
            f"type={self.capability_type}, "
            f"employee={self.employee_id}, "
            f"initialized={self._initialized})"
        )
